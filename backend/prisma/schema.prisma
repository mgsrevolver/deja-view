// Déjà View Database Schema
// PostgreSQL via Supabase

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - links to Supabase Auth
model User {
  id        String   @id // Supabase Auth UUID (not auto-generated)
  email     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  locations   Location[]
  visits      Visit[]
  dayData     DayData[]
  enrichments Enrichment[]
}

// Raw GPS pings (for path drawing and distance calculations)
model Location {
  id           String   @id @default(uuid())
  userId       String?  // Nullable during migration, will be required after data migration
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  lat          Float
  lon          Float
  timestamp    DateTime
  source       String   // "path", "activity_start", "activity_end"
  activityType String?  // "WALKING", "BIKING", "IN_VEHICLE" (for activity points)
  createdAt    DateTime @default(now())

  @@index([userId, timestamp]) // Primary query pattern
  @@index([userId, lat, lon])  // Spatial queries scoped to user
}

// Visit records - time spent at a specific place
model Visit {
  id              String   @id @default(uuid())
  userId          String?  // Nullable during migration, will be required after data migration
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  placeID         String   // Google Place ID (may not exist in Place table yet)
  lat             Float    // Visit location
  lon             Float
  startTime       DateTime
  endTime         DateTime?
  durationMinutes Int?     // Calculated from start/end

  semanticType    String?  // "Inferred Home", "Work", "Unknown Location"
  probability     Float?   // Confidence score from Google

  place           Place?   @relation(fields: [placeID], references: [id])

  createdAt       DateTime @default(now())

  @@index([userId, startTime]) // Primary query pattern
  @@index([userId, placeID])   // User's visits to a place
  @@index([placeID])           // Keep for place-level queries
}

// Unique places (enriched with Google Places API data)
model Place {
  id              String   @id // Google Place ID

  // Google Places API data (enriched after import)
  name            String?
  defaultImageUrl String?
  address         String?
  types           String[] // ["restaurant", "cafe"]

  // Visit statistics (calculated from Visit records)
  firstVisit      DateTime?
  lastVisit       DateTime?
  totalVisits     Int      @default(0)
  uniqueDays      Int      @default(0)
  longestStreak   Int      @default(0)

  visits          Visit[]
  enrichments     Enrichment[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([name])
}

// Day-level aggregations (one record per user per date)
model DayData {
  id              String   @id @default(uuid())
  userId          String?  // Nullable during migration, will be required after data migration
  user            User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  date            DateTime // Date at midnight UTC

  // Distance analytics (calculated from activity segments)
  distanceByType  Json     // {"walking": 5200, "biking": 12000, "driving": 45000} meters
  totalDistance   Int      @default(0) // meters

  // Weather data (from Open-Meteo API)
  weather         Json?    // {"tempMax": 72, "tempMin": 58, "condition": "Partly Cloudy", "precipitation": 0}

  // Spotify data
  spotifyTracks   Json?    // [{name, artist, album, playedAt}, ...]
  topArtists      String[]

  // News/context (future)
  newsHeadlines   Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, date]) // One record per user per date
  @@index([userId, date])  // Primary query pattern
}

// Enrichment tracker (prevents duplicate API calls)
model Enrichment {
  id          String   @id @default(uuid())
  userId      String?  // Null for system-level enrichments (e.g., shared place data)
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // "google_places", "weather", "spotify", "distance"
  status      String   // "pending", "complete", "failed", "rate_limited"

  visitId     String?   // For visit-level enrichments

  placeId     String?
  place       Place?    @relation(fields: [placeId], references: [id])

  date        DateTime? // For day-level enrichments
  metadata    Json?     // Error messages, API response details

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId, type, status]) // User's enrichments by type
  @@index([type, status])         // System-wide enrichment queries
  @@index([visitId])
  @@index([date])
}
